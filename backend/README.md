# Backend Service - Document Processing API

This service is the backend for the document processing application. It handles document uploads, extracts text using Apache Tika, stores metadata and extracted text in a PostgreSQL database, and provides API endpoints to manage and retrieve document information.

## Prerequisites

- Docker and Docker Compose
- Node.js (for local development outside Docker, if preferred)

## Environment Variables

The service uses the following environment variables:

- `PORT`: The port on which the Express server will listen (default: `3001`).
- `DATABASE_URL`: The connection string for the PostgreSQL database (e.g., `postgresql://user:password@db:5432/document_processing`). This is typically provided by Docker Compose.
- `TIKA_URL`: The URL for the Apache Tika service (e.g., `http://tika:9998/tika`). This is typically provided by Docker Compose.
- `NODE_ENV`: Set to `development` or `production`.

## Setup and Running

### Using Docker Compose (Recommended)

The entire application stack (backend, frontend, database, Tika) can be managed using Docker Compose from the project root:

1.  **Build images and start services:**
    ```bash
    docker-compose up --build
    ```
2.  To run in detached mode:
    ```bash
    docker-compose up --build -d
    ```
3.  The backend service will be available at `http://localhost:3001` (or the mapped port if changed in `docker-compose.yml`).

### Local Development (outside Docker, for backend only)

1.  **Navigate to the `backend` directory:**
    ```bash
    cd backend
    ```
2.  **Install dependencies:**
    ```bash
    npm install
    ```
3.  **Ensure PostgreSQL and Tika services are running and accessible.** You might need to run them via Docker Compose separately or have local instances. Update `DATABASE_URL` and `TIKA_URL` in your environment or a `.env` file accordingly.
4.  **Compile TypeScript (if making changes):**
    ```bash
    npm run build
    ```
5.  **Run the development server (with hot reloading):**
    ```bash
    npm run dev
    ```
6.  **Run the production build:**
    ```bash
    npm start
    ```

## API Endpoints

Here are the primary API endpoints:

- **`POST /api/upload`**:
    - Uploads a document for processing.
    - Expects `multipart/form-data` with a field named `document`.
    - On success, returns JSON with `documentId`, `filename`, and `originalname`.
    - Example: `curl -X POST -F "document=@/path/to/your/file.pdf" http://localhost:3001/api/upload`

- **`GET /api/document/:id`**:
    - Retrieves details for a specific document, including its status and extracted text (if available).
    - Replace `:id` with the document's ID.
    - Example: `curl http://localhost:3001/api/document/1`

- **`GET /api/document/:id/status`**:
    - Retrieves the current processing status of a specific document.
    - Replace `:id` with the document's ID.
    - Example: `curl http://localhost:3001/api/document/1/status`

- **`GET /api/documents`**:
    - Returns a list of all uploaded documents and their metadata.
    - Example: `curl http://localhost:3001/api/documents`

## Project Structure

- `src/`: Contains the TypeScript source code.
    - `index.ts`: Main application file, sets up Express, routes, and middleware.
    - `db.ts`: Handles database connection (PostgreSQL) and queries.
- `dist/`: Contains the compiled JavaScript code (generated by `npm run build`).
- `uploads/`: Temporarily stores uploaded files before processing (should be gitignored, and is).
- `Dockerfile`: For building the backend service Docker image.
- `tsconfig.json`: TypeScript compiler configuration.
- `package.json`: Project dependencies and scripts.
